{% extends "base.html" %}

{% block content %}
<div style="padding-top: 20px; height: calc(100vh - 100px); display: flex; flex-direction: column;">
    <!-- Header -->
    <div style="margin-bottom: 20px;">
        <a href="/trip/{{ trip.id }}"
            style="color: #6C63FF; text-decoration: none; display: inline-flex; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 1.5rem; margin-right: 8px;">‚Üê</span> Back to Trip
        </a>
        <h1 style="margin: 10px 0;">üí¨ {{ trip.name }} - Group Chat</h1>
        <p style="color: #888; margin: 5px 0 0 0;">Coordinate your trip plans in real-time</p>
    </div>

    <!-- Chat Container -->
    <div class="glass-card" style="flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden;">

        <!-- Messages Area -->
        <div id="messagesContainer"
            style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px;">
            {% if messages %}
            {% for message in messages %}
            <div class="message" data-message-id="{{ message.id }}"
                style="display: flex; gap: 12px; {% if message.user_id == user.id %}flex-direction: row-reverse;{% endif %}">
                <!-- Avatar -->
                <div
                    style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6C63FF, #5a52d5); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; flex-shrink: 0;">
                    {{ message.user.full_name[0].upper() if message.user.full_name else message.user.email[0].upper() }}
                </div>

                <!-- Message Bubble -->
                <div style="max-width: 60%; {% if message.user_id == user.id %}text-align: right;{% endif %}">
                    <div
                        style="background: {% if message.user_id == user.id %}linear-gradient(135deg, #6C63FF, #5a52d5){% else %}rgba(255,255,255,0.1){% endif %}; padding: 12px 16px; border-radius: 16px; {% if message.user_id == user.id %}border-bottom-right-radius: 4px;{% else %}border-bottom-left-radius: 4px;{% endif %}">
                        <p
                            style="margin: 0 0 4px 0; font-size: 0.85rem; font-weight: 600; color: {% if message.user_id == user.id %}rgba(255,255,255,0.8){% else %}#aaa{% endif %};">
                            {{ message.user.full_name or message.user.email }}
                        </p>
                        <p style="margin: 0; line-height: 1.5; word-wrap: break-word;">{{ message.content }}</p>
                    </div>
                    <p style="margin: 4px 0 0 0; font-size: 0.75rem; color: #666;">
                        {{ message.timestamp.strftime('%I:%M %p') if message.timestamp else '' }}
                    </p>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div id="emptyState" style="text-align: center; padding: 60px 20px; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;">üí¨</div>
                <p>No messages yet. Start the conversation!</p>
            </div>
            {% endif %}
        </div>

        <!-- Input Area -->
        <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
            <form id="messageForm" action="/trip/{{ trip.id }}/message" method="post" style="display: flex; gap: 12px;">
                <input type="text" name="content" id="messageInput" placeholder="Type your message..." required
                    autocomplete="off"
                    style="flex: 1; padding: 14px 20px; border-radius: 24px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                <button type="submit" class="btn"
                    style="padding: 14px 28px; border-radius: 24px; background: linear-gradient(135deg, #6C63FF, #5a52d5);">
                    Send üì§
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    /* Custom scrollbar for messages */
    #messagesContainer::-webkit-scrollbar {
        width: 8px;
    }

    #messagesContainer::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
    }

    #messagesContainer::-webkit-scrollbar-thumb {
        background: rgba(108, 99, 255, 0.5);
        border-radius: 4px;
    }

    #messagesContainer::-webkit-scrollbar-thumb:hover {
        background: rgba(108, 99, 255, 0.7);
    }

    /* Message animation */
    .message {
        animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    const tripId = {{ trip.id }};
    const currentUserId = {{ user.id }};
    let lastMessageId = {% if messages %}{ { messages[-1].id } } {% else %} 0{% endif %};
    let isPolling = true;

    // Scroll to bottom on load
    window.addEventListener('load', () => {
        scrollToBottom();
    });

    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
    }

    // Auto-refresh messages every 2 seconds
    async function pollMessages() {
        if (!isPolling) return;

        try {
            const response = await fetch(`/api/trip/${tripId}/messages?since_id=${lastMessageId}`);
            if (response.ok) {
                const newMessages = await response.json();

                if (newMessages.length > 0) {
                    // Remove empty state if it exists
                    const emptyState = document.getElementById('emptyState');
                    if (emptyState) {
                        emptyState.remove();
                    }

                    // Add new messages
                    const container = document.getElementById('messagesContainer');
                    newMessages.forEach(msg => {
                        const messageDiv = createMessageElement(msg);
                        container.appendChild(messageDiv);
                        lastMessageId = Math.max(lastMessageId, msg.id);
                    });

                    scrollToBottom();
                }
            }
        } catch (error) {
            console.error('Error polling messages:', error);
        }

        // Poll again after 2 seconds
        setTimeout(pollMessages, 2000);
    }

    function createMessageElement(msg) {
        const isOwnMessage = msg.user_id === currentUserId;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.setAttribute('data-message-id', msg.id);
        messageDiv.style.cssText = `display: flex; gap: 12px; ${isOwnMessage ? 'flex-direction: row-reverse;' : ''}`;

        messageDiv.innerHTML = `
            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6C63FF, #5a52d5); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; flex-shrink: 0;">
                ${msg.user_initial}
            </div>
            <div style="max-width: 60%; ${isOwnMessage ? 'text-align: right;' : ''}">
                <div style="background: ${isOwnMessage ? 'linear-gradient(135deg, #6C63FF, #5a52d5)' : 'rgba(255,255,255,0.1)'}; padding: 12px 16px; border-radius: 16px; ${isOwnMessage ? 'border-bottom-right-radius: 4px;' : 'border-bottom-left-radius: 4px;'}">
                    <p style="margin: 0 0 4px 0; font-size: 0.85rem; font-weight: 600; color: ${isOwnMessage ? 'rgba(255,255,255,0.8)' : '#aaa'};">
                        ${msg.user_name}
                    </p>
                    <p style="margin: 0; line-height: 1.5; word-wrap: break-word;">${escapeHtml(msg.content)}</p>
                </div>
                <p style="margin: 4px 0 0 0; font-size: 0.75rem; color: #666;">
                    ${msg.timestamp}
                </p>
            </div>
        `;

        return messageDiv;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Handle form submission
    document.getElementById('messageForm').addEventListener('submit', (e) => {
        const input = document.getElementById('messageInput');
        if (!input.value.trim()) {
            e.preventDefault();
            return;
        }
        // Form will submit normally, then page will reload
        // Stop polling temporarily to avoid duplicates
        isPolling = false;
    });

    // Start polling
    setTimeout(pollMessages, 2000);

    // Focus input on load
    document.getElementById('messageInput').focus();
</script>
{% endblock %}