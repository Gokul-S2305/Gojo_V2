{% extends "base.html" %}

{% block content %}
<div style="padding-top: 20px;">
    <!-- Back Button & Export -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <a href="/dashboard" style="color: #6C63FF; text-decoration: none; display: inline-flex; align-items: center;">
            <span style="font-size: 1.5rem; margin-right: 8px;">‚Üê</span> Back to Dashboard
        </a>
        <a href="/trip/{{ trip.id }}/export/pdf" class="btn"
            style="background: linear-gradient(135deg, #FF6B6B, #EE5A6F); text-decoration: none;">
            üìÑ Export PDF
        </a>
    </div>

    <!-- Trip Header -->
    <div class="glass-card"
        style="margin-bottom: 30px; background: linear-gradient(135deg, rgba(108, 99, 255, 0.1), rgba(90, 82, 213, 0.1));">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
            <div>
                <h1 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ trip.name }}</h1>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <p style="color: #ccc; font-size: 1.2rem; margin: 0;">üü¢ {{ trip.start_location or 'Start' }}</p>
                    <p style="color: #ccc; font-size: 1.2rem; margin: 0; padding-left: 5px;">‚¨áÔ∏è</p>
                    <p style="color: #ccc; font-size: 1.2rem; margin: 0;">üìç {{ trip.destination }}</p>
                </div>
                {% if trip.estimated_budget %}
                <p style="color: #00C9FF; font-size: 1rem; margin: 5px 0 0 0;">üí∞ Est. Budget: ‚Çπ{{
                    "%.2f"|format(trip.estimated_budget) }}</p>
                {% endif %}
            </div>
            <div style="text-align: right;">
                <div
                    style="background: rgba(255,255,255,0.1); padding: 12px 20px; border-radius: 12px; margin-bottom: 10px;">
                    <p style="margin: 0; color: #888; font-size: 0.85rem;">Join Code</p>
                    <p style="margin: 5px 0 0 0; font-family: monospace; font-size: 1.5rem; font-weight: 700; letter-spacing: 3px;"
                        id="joinCode">{{ trip.join_code }}</p>
                </div>
                <button onclick="copyJoinCode()" class="btn"
                    style="width: 100%; background: rgba(255,255,255,0.1); font-size: 0.9rem;">
                    üìã Copy Code
                </button>
            </div>
        </div>

        <div
            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div>
                <p style="color: #888; margin: 0; font-size: 0.9rem;">Start Date</p>
                <p style="margin: 5px 0 0 0; font-size: 1.1rem;">üìÖ {{ trip.start_date }}</p>
            </div>
            <div>
                <p style="color: #888; margin: 0; font-size: 0.9rem;">End Date</p>
                <p style="margin: 5px 0 0 0; font-size: 1.1rem;">üìÖ {{ trip.end_date }}</p>
            </div>
            <div>
                <p style="color: #888; margin: 0; font-size: 0.9rem;">Duration</p>
                <p style="margin: 5px 0 0 0; font-size: 1.1rem;">‚è±Ô∏è {{ duration }} days</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div
            style="display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="/trip/{{ trip.id }}/map" class="btn"
                style="flex: 1; text-align: center; background: linear-gradient(135deg, #00C9FF, #92FE9D); text-decoration: none;">
                üó∫Ô∏è View Smart Map
            </a>
            <a href="/trip/{{ trip.id }}/gallery" class="btn"
                style="flex: 1; text-align: center; background: linear-gradient(135deg, #FF6B9D, #C06C84); text-decoration: none;">
                üì∏ Gallery
            </a>
            <a href="/trip/{{ trip.id }}/chat" class="btn"
                style="flex: 1; text-align: center; background: linear-gradient(135deg, #A29BFE, #6C5CE7); text-decoration: none;">
                üí¨ Chat
            </a>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">

        <!-- Left Column: Members -->
        <!-- Left Column: Itinerary & Members -->
        <div>
            <!-- Itinerary Section -->
            <div class="glass-card" style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Itinerary</h2>
                    {% if is_organizer %}
                    <button onclick="document.getElementById('addItineraryModal').style.display='flex'" class="btn"
                        style="padding: 8px 16px; font-size: 0.9rem;">+ Add Item</button>
                    {% endif %}
                </div>

                {% if itinerary %}
                <div style="position: relative; padding-left: 20px; border-left: 2px solid rgba(255,255,255,0.1);">
                    {% for item in itinerary %}
                    <div style="margin-bottom: 20px; position: relative;">
                        <!-- Dot -->
                        <div
                            style="position: absolute; left: -27px; top: 0; width: 12px; height: 12px; background: #6C63FF; border-radius: 50%; border: 2px solid #1a1a2e;">
                        </div>

                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-weight: bold; color: #00C9FF;">Day {{ item.day_number }} - {{
                                    item.time }}</span>
                                {% if is_organizer %}
                                <form action="/trip/{{ trip.id }}/itinerary/{{ item.id }}/delete" method="post"
                                    style="display: inline;" onsubmit="return confirm('Delete this item?');">
                                    <button type="submit"
                                        style="background: none; border: none; color: #ff6b6b; cursor: pointer;">‚úï</button>
                                </form>
                                {% endif %}
                            </div>
                            <h4 style="margin: 5px 0;">{{ item.activity }}</h4>
                            {% if item.location %}
                            <p style="margin: 0; color: #ccc; font-size: 0.9rem;">üìç {{ item.location }}</p>
                            {% endif %}
                            {% if item.description %}
                            <p style="margin: 5px 0 0 0; color: #888; font-size: 0.9rem;">{{ item.description }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: #666; text-align: center;">No itinerary planned yet.</p>
                {% endif %}
            </div>

            <!-- Members Section -->
            <div class="glass-card">
                <h2 style="margin-top: 0;">Trip Members</h2>

                <!-- Organizers -->
                {% if organizers %}
                <h4 style="color: #00C9FF; margin-bottom: 10px;">Organizers</h4>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                    {% for member in organizers %}
                    <div
                        style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(0, 201, 255, 0.1); border-radius: 8px; border: 1px solid rgba(0, 201, 255, 0.2);">
                        <div
                            style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #00C9FF, #92FE9D); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: #000;">
                            {{ member.full_name[0].upper() if member.full_name else member.email[0].upper() }}
                        </div>
                        <div style="flex: 1;">
                            <p style="margin: 0; font-weight: 600;">{{ member.full_name or 'User' }} <span
                                    style="font-size: 0.8rem; background: #00C9FF; color: black; padding: 2px 6px; border-radius: 4px; margin-left: 5px;">ORG</span>
                            </p>
                            <p style="margin: 0; color: #888; font-size: 0.85rem;">{{ member.email }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Regular Members -->
                {% if members %}
                <h4 style="color: #888; margin-bottom: 10px;">Members</h4>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    {% for member in members %}
                    <div
                        style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div
                            style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6C63FF, #5a52d5); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem;">
                            {{ member.full_name[0].upper() if member.full_name else member.email[0].upper() }}
                        </div>
                        <div style="flex: 1;">
                            <p style="margin: 0; font-weight: 600;">{{ member.full_name or 'User' }}</p>
                            <p style="margin: 0; color: #888; font-size: 0.85rem;">{{ member.email }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Budget & Expenses -->
        <div>
            <!-- Budget Summary -->
            <div class="glass-card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: var(--color-neutral-gray-900);">Total Budget</h2>
                    <p
                        style="margin: 0; font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #00C9FF, #92FE9D); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        ‚Çπ{{ "%.2f"|format(total_expenses) }}
                    </p>
                </div>
            </div>

            <!-- Add Expense Form -->
            <div class="glass-card" style="margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: var(--color-neutral-gray-900);">Add Expense</h3>
                <form action="/trip/{{ trip.id }}/expense" method="post"
                    style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: end;">
                    <div>
                        <input type="text" name="purpose" placeholder="Purpose (e.g., Hotel, Food)" required
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: var(--color-neutral-gray-900); transition: all 0.3s ease;"
                            onfocus="this.style.background='rgba(255,255,255,0.15)'; this.style.borderColor='#00C9FF';"
                            onblur="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,255,255,0.2)';">
                    </div>
                    <div>
                        <input type="number" name="amount" placeholder="Amount" step="0.01" required
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: var(--color-neutral-gray-900); transition: all 0.3s ease;"
                            onfocus="this.style.background='rgba(255,255,255,0.15)'; this.style.borderColor='#00C9FF';"
                            onblur="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,255,255,0.2)';">
                    </div>
                    <button type="submit" class="btn" style="padding: 12px 24px;">
                        ‚ûï Add
                    </button>
                </form>
            </div>

            <!-- Expenses List -->
            <div class="glass-card">
                <h3 style="margin-top: 0; color: var(--color-neutral-gray-900);">Expenses</h3>
                {% if expenses %}
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th
                                    style="text-align: left; padding: 12px; color: var(--color-neutral-gray-900); font-weight: 600;">
                                    Purpose</th>
                                <th
                                    style="text-align: right; padding: 12px; color: var(--color-neutral-gray-900); font-weight: 600;">
                                    Amount</th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--color-neutral-gray-900); font-weight: 600;">
                                    Added By
                                </th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--color-neutral-gray-900); font-weight: 600;">
                                    Date</th>
                                <th
                                    style="text-align: center; padding: 12px; color: var(--color-neutral-gray-900); font-weight: 600;">
                                    Action
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td style="padding: 12px; color: var(--color-neutral-gray-800);">{{ expense.purpose }}
                                </td>
                                <td style="padding: 12px; text-align: right; font-weight: 600; color: #00C9FF;">‚Çπ{{
                                    "%.2f"|format(expense.amount) }}</td>
                                <td style="padding: 12px; color: var(--color-neutral-gray-800);">{{
                                    expense.user.full_name or expense.user.email
                                    }}</td>
                                <td style="padding: 12px; color: var(--color-neutral-gray-700); font-size: 0.9rem;">{{
                                    expense.created_at.strftime('%b %d, %Y') if expense.created_at else 'N/A' }}</td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if expense.user_id == user.id %}
                                    <form action="/trip/{{ trip.id }}/expense/{{ expense.id }}/delete" method="post"
                                        style="display: inline;" onsubmit="return confirm('Delete this expense?');">
                                        <button type="submit"
                                            style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 1.2rem;"
                                            title="Delete">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 40px; color: var(--color-neutral-gray-500);">
                    <p style="color: var(--color-neutral-gray-700);">No expenses added yet. Add your first expense
                        above!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Smart Suggestions Section -->
    <div style="margin-top: 40px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <h2 style="margin: 0;">‚ú® AI Smart Suggestions</h2>
            <span
                style="background: linear-gradient(135deg, #FF6B9D, #FFC06C); padding: 4px 12px; border-radius: 20px; color: white; font-size: 0.8em; font-weight: bold;">NEW</span>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <!-- Recommended Stays -->
            <div class="glass-card">
                <h3 style="margin-top: 0; margin-bottom: 20px;">üè® Recommended Stays</h3>
                <div id="hotelRecommendations">
                    <div style="text-align: center; padding: 20px;">
                        <p style="color: #ccc; margin-bottom: 15px;">Explore top-rated stays with sentiment analysis.
                        </p>
                        <a href="/trip/{{ trip.id }}/map" class="btn" style="background: rgba(255,255,255,0.1);">View
                            Recommendations on Map</a>
                    </div>
                </div>
            </div>

            <!-- Recommended Eats -->
            <div class="glass-card">
                <h3 style="margin-top: 0; margin-bottom: 20px;">üçΩÔ∏è Places to Eat</h3>
                <div id="foodRecommendations">
                    <div style="text-align: center; padding: 20px;">
                        <p style="color: #ccc; margin-bottom: 15px;">Discover highly rated restaurants and cafes.</p>
                        <a href="/trip/{{ trip.id }}/map" class="btn" style="background: rgba(255,255,255,0.1);">View
                            Recommendations on Map</a>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        // Fetch Suggestions from Map API endpoint (Client-side fetch for dynamic feel)
        // Alternatively, we can pass them from backend. 
        // For now, let's assume we view them on the Map page or link to Map page for details.
        // Actually, let's replace the loading text with a link to the Map page where detailed suggestions live.

        document.getElementById('hotelRecommendations').innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <p style="color: #ccc; margin-bottom: 15px;">Explore top-rated stays with sentiment analysis.</p>
                <a href="/trip/{{ trip.id }}/map" class="btn" style="background: rgba(255,255,255,0.1);">View Recommendations on Map</a>
            </div>
        `;

        document.getElementById('foodRecommendations').innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <p style="color: #ccc; margin-bottom: 15px;">Discover highly rated restaurants and cafes.</p>
                <a href="/trip/{{ trip.id }}/map" class="btn" style="background: rgba(255,255,255,0.1);">View Recommendations on Map</a>
            </div>
        `;
    </script>
</div>

<!-- Add Itinerary Modal -->
<div id="addItineraryModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 100%; max-width: 500px; position: relative;">
        <button onclick="document.getElementById('addItineraryModal').style.display='none'"
            style="position: absolute; right: 20px; top: 20px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">‚úï</button>
        <h2>Add Itinerary Item</h2>
        <form action="/trip/{{ trip.id }}/itinerary/add" method="post">
            <input type="number" name="day_number" placeholder="Day Number (e.g., 1)" required
                style="width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 8px; border: none; color: black;">
            <input type="time" name="time" required
                style="width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 8px; border: none; color: black;">
            <input type="text" name="activity" placeholder="Activity Name" required
                style="width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 8px; border: none; color: black;">
            <input type="text" name="location" placeholder="Location Name"
                style="width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 8px; border: none; color: black;">
            <textarea name="description" placeholder="Description / Route Details" rows="3"
                style="width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 8px; border: none; resize: vertical; color: black;"></textarea>
            <button type="submit" class="btn" style="width: 100%;">Add Item</button>
        </form>
    </div>
</div>

<script>
    function copyJoinCode() {
        const code = document.getElementById('joinCode').textContent;
        navigator.clipboard.writeText(code).then(() => {
            // Show toast notification
            showToast('Join code copied to clipboard!');
        });
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #6C63FF, #5a52d5);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Add animations
    const style = document.createElement('style');
    style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
    document.head.appendChild(style);
</script>
{% endblock %}